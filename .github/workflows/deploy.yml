name: Deploy to AWS Elastic Beanstalk

on:
  push:
    branches:
      - main  # Deploys when pushing to the main branch

jobs:
  deploy:
    name: Deploy to AWS Elastic Beanstalk
    runs-on: ubuntu-latest

    steps:
      - name: ðŸš€ Checkout Repository
        uses: actions/checkout@v4

      # âœ… Install AWS CLI
      - name: ðŸ”¹ Install AWS CLI
        run: |
          sudo apt update
          sudo apt install -y python3-pip
          python3 -m pip install --upgrade pip
          python3 -m pip install awscli --upgrade --user
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          aws --version

      # âœ… Authenticate AWS CLI
      - name: ðŸ”¹ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # âœ… Install AWS Elastic Beanstalk CLI
      - name: ðŸ”¹ Install AWS EB CLI
        run: |
          sudo apt update && sudo apt install -y python3-pip
          python3 -m pip install awsebcli --upgrade --user
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          eb --version  # Verify EB CLI installation

      # âœ… Ensure ECR Repository Exists
      - name: ðŸ”¹ Create ECR Repository If Not Exists
        run: |
          aws ecr describe-repositories --repository-names my-app || \
          aws ecr create-repository --repository-name my-app

      # âœ… Authenticate Docker with Amazon ECR
      - name: ðŸ”¹ Login to Amazon ECR
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com

      # âœ… Build & Push Docker Image
      - name: ðŸ³ Build & Push Docker Image to ECR
        run: |
          docker buildx build --platform linux/amd64 \
            --build-arg REACT_APP_GOOGLE_PLACES_API_KEY=${{ secrets.REACT_APP_GOOGLE_PLACES_API_KEY }} \
            --build-arg REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL }} \
            --build-arg OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }} \
            -t my-app .
          
          docker tag my-app:latest ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/my-app:latest
          docker push ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/my-app:latest

      # âœ… Deploy to Elastic Beanstalk
      - name: ðŸ“¦ Deploy Docker Image to AWS Elastic Beanstalk
        run: |
          export PATH=$HOME/.local/bin:$PATH

          eb init ${{ secrets.EB_APPLICATION_NAME }} --region ${{ secrets.AWS_REGION }} --platform "Docker"
          eb use ${{ secrets.EB_ENVIRONMENT_NAME }}
          
          eb setenv REACT_APP_GOOGLE_PLACES_API_KEY=${{ secrets.REACT_APP_GOOGLE_PLACES_API_KEY }} \
                    REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL }} \
                    OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}

          eb deploy

      # âœ… Fetch Logs for Debugging
      - name: ðŸ” Fetch Elastic Beanstalk Logs
        run: |
          eb logs > eb-logs.txt
          cat eb-logs.txt
