name: Deploy to AWS Elastic Beanstalk

on:
  push:
    branches:
      - main  # Deploys when pushing to the main branch

jobs:
  deploy:
    name: Deploy to AWS Elastic Beanstalk
    runs-on: ubuntu-latest

    steps:
      - name: 🚀 Checkout Repository
        uses: actions/checkout@v4

      # ✅ Install AWS CLI
      - name: 🔹 Install AWS CLI
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install
          aws --version

      # ✅ Authenticate AWS CLI
      - name: 🔹 Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ✅ Authenticate Docker with Amazon ECR
      - name: 🔹 Login to Amazon ECR
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com

      # ✅ Build & Push Docker Image
      - name: 🐳 Build & Push Docker Image to ECR
        run: |
          docker buildx build --platform linux/amd64 \
            --build-arg REACT_APP_GOOGLE_PLACES_API_KEY=${{ secrets.REACT_APP_GOOGLE_PLACES_API_KEY }} \
            --build-arg REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL }} \
            --build-arg OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }} \
            -t my-app .
          
          docker tag my-app:latest ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/my-app:latest
          docker push ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/my-app:latest

      # ✅ Deploy to Elastic Beanstalk
      - name: 📦 Deploy Docker Image to AWS Elastic Beanstalk
        run: |
          eb init ${{ secrets.EB_APPLICATION_NAME }} --region ${{ secrets.AWS_REGION }} --platform "Docker"
          eb use ${{ secrets.EB_ENVIRONMENT_NAME }}
          
          eb setenv REACT_APP_GOOGLE_PLACES_API_KEY=${{ secrets.REACT_APP_GOOGLE_PLACES_API_KEY }} \
                    REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL }} \
                    OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}

          eb deploy

      # ✅ Fetch Logs for Debugging
      - name: 🔍 Fetch Elastic Beanstalk Logs
        run: |
          eb logs > eb-logs.txt
          cat eb-logs.txt
