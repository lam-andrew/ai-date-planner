name: CI/CD Pipeline for AI Date Planner

on:
  push:
    branches:
      - main  # Deploys the app when code is pushed to the main branch

jobs:
  build:
    name: Build & Test Application
    runs-on: ubuntu-latest

    steps:
      - name: ðŸš€ Checkout repository
        uses: actions/checkout@v3

      # âœ… Install Node.js for Frontend Build
      - name: ðŸ”¹ Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # âœ… Install & Build Frontend
      - name: ðŸ“¦ Install Frontend Dependencies
        working-directory: frontend
        run: npm install

      - name: ðŸ”¨ Build Frontend
        working-directory: frontend
        run: npm run build

      # âœ… Install Python Dependencies for Backend
      - name: ðŸ Install Backend Dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

  deploy:
    name: Deploy Application to AWS
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: ðŸš€ Checkout repository
        uses: actions/checkout@v3

      # âœ… Authenticate with AWS
      - name: ðŸ”¹ Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # âœ… Install AWS Elastic Beanstalk CLI
      - name: ðŸ”¹ Install AWS Elastic Beanstalk CLI
        run: |
          sudo apt update && sudo apt install -y python3-pip
          python3 -m pip install --upgrade pip
          python3 -m pip install awsebcli --upgrade --user
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      # âœ… Ensure ECR Repository Exists
      - name: ðŸ—ï¸ Ensure ECR Repository Exists
        run: |
          aws ecr describe-repositories --repository-names my-app || \
          aws ecr create-repository --repository-name my-app || echo "Repository already exists."

      # âœ… Authenticate Docker with Amazon ECR
      - name: ðŸ”¹ Login to Amazon ECR
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | \
          docker login --username AWS --password-stdin ${{ secrets.ECR_REPOSITORY_URI }}

      # âœ… Build & Push Docker Image
      - name: ðŸ³ Build & Push Docker Image to ECR
        run: |
          docker buildx build --platform linux/amd64 \
            --build-arg REACT_APP_GOOGLE_PLACES_API_KEY=${{ secrets.REACT_APP_GOOGLE_PLACES_API_KEY }} \
            --build-arg REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL }} \
            --build-arg GOOGLE_PLACES_API_KEY=${{ secrets.GOOGLE_PLACES_API_KEY }} \
            --build-arg OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }} \
            -t my-app .
          
          docker tag my-app:latest ${{ secrets.ECR_REPOSITORY_URI }}:latest
          docker push ${{ secrets.ECR_REPOSITORY_URI }}:latest

      # âœ… Initialize Elastic Beanstalk
      - name: ðŸ—ï¸ Initialize Elastic Beanstalk
        run: |
          export PATH=$HOME/.local/bin:$PATH  # Ensure EB CLI is in PATH
          
          eb init ${{ secrets.EB_APPLICATION_NAME }} --region ${{ secrets.AWS_REGION }} --platform "Docker"
          eb use ${{ secrets.EB_ENVIRONMENT_NAME }}

      # âœ… Set Environment Variables in Elastic Beanstalk
      - name: ðŸ”¹ Set Backend Environment Variables in Elastic Beanstalk
        run: |
          eb setenv REACT_APP_GOOGLE_PLACES_API_KEY=${{ secrets.REACT_APP_GOOGLE_PLACES_API_KEY }} \
                    REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL }} \
                    GOOGLE_PLACES_API_KEY=${{ secrets.GOOGLE_PLACES_API_KEY }} \
                    OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}

      # âœ… Deploy to AWS Elastic Beanstalk
      - name: ðŸš€ Deploy to Elastic Beanstalk
        run: |
          sleep 60
          eb deploy

      # âœ… Fetch Logs for Debugging
      - name: ðŸ“œ Fetch Elastic Beanstalk Logs
        run: |
          eb logs > eb-logs.txt
          cat eb-logs.txt
